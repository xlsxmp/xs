#!/bin/bash

# ============================================================
#  Debian 12 一键安装 VLESS + WS + TLS + Nginx + Cloudflare
#  自动生成随机伪装站点 + 输出节点信息 + 写入文本文件
#  作者：Grok（旗舰整合版）
# ============================================================

set -euo pipefail

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}=== VLESS-WS-TLS + Nginx + Cloudflare 一键脚本（旗舰版） ===${NC}"
echo -e "${YELLOW}适用于 Debian 12，证书使用 Cloudflare DNS-01 验证${NC}"
echo

# 检查 root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}错误：请用 root 权限运行此脚本${NC}"
   exit 1
fi

# 输入域名
read -p "请输入你的域名（例如 vless.example.com）: " DOMAIN
if [[ -z "$DOMAIN" ]]; then
    echo -e "${RED}域名不能为空！${NC}"
    exit 1
fi

# Cloudflare 认证方式
echo
echo -e "${YELLOW}Cloudflare API 认证方式：${NC}"
echo "1) API Token（推荐，仅 DNS 权限）"
echo "2) Global API Key（不推荐）"
read -p "请选择 [1/2，默认 1]: " CF_MODE
CF_MODE=${CF_MODE:-1}

CF_EMAIL=""
CF_TOKEN=""
CF_KEY=""

if [[ "$CF_MODE" == "1" ]]; then
    read -p "请输入 Cloudflare API Token: " CF_TOKEN
    if [[ -z "$CF_TOKEN" ]]; then
        echo -e "${RED}API Token 不能为空！${NC}"
        exit 1
    fi
else
    read -p "请输入 Cloudflare 邮箱: " CF_EMAIL
    read -p "请输入 Cloudflare Global API Key: " CF_KEY
    if [[ -z "$CF_EMAIL" || -z "$CF_KEY" ]]; then
        echo -e "${RED}邮箱和 API Key 不能为空！${NC}"
        exit 1
    fi
fi

# WS 路径
read -p "请输入 WebSocket 路径（例如 /ray2026）[默认 /vlessws]: " WS_PATH
WS_PATH=${WS_PATH:-/vlessws}
[[ "${WS_PATH:0:1}" != "/" ]] && { echo -e "${RED}WS 路径必须以 / 开头${NC}"; exit 1; }

# Xray 端口
read -p "请输入 Xray 本地端口 [默认 10000]: " XRAY_PORT
XRAY_PORT=${XRAY_PORT:-10000}

# UUID
UUID=$(cat /proc/sys/kernel/random/uuid)

echo
echo -e "${GREEN}配置信息确认：${NC}"
echo "域名: $DOMAIN"
echo "WS 路径: $WS_PATH"
echo "Xray 端口: $XRAY_PORT"
echo "UUID: $UUID"
echo
read -p "确认无误？(y/N): " CONFIRM
[[ ! "$CONFIRM" =~ ^[Yy]$ ]] && exit 0

# 安装依赖
echo -e "${GREEN}安装依赖...${NC}"
apt update && apt install -y curl wget socat nginx unzip cron uuid-runtime

# 安装 acme.sh
echo -e "${GREEN}安装 acme.sh...${NC}"
if [[ ! -d "/root/.acme.sh" ]]; then
    curl https://get.acme.sh | sh
fi
ACME="/root/.acme.sh/acme.sh"
chmod +x "$ACME"
"$ACME" --upgrade --auto-upgrade
"$ACME" --set-default-ca --server letsencrypt

# Cloudflare 环境变量
if [[ "$CF_MODE" == "1" ]]; then
    export CF_Token="$CF_TOKEN"
else
    export CF_Key="$CF_KEY"
    export CF_Email="$CF_EMAIL"
fi

# 申请证书
echo -e "${GREEN}申请证书...${NC}"
"$ACME" --issue --dns dns_cf -d "$DOMAIN" --force

# 安装证书
CERT_PATH="/etc/ssl/vless/$DOMAIN"
mkdir -p "$CERT_PATH"
"$ACME" --install-cert -d "$DOMAIN" \
    --key-file "$CERT_PATH/privkey.pem" \
    --fullchain-file "$CERT_PATH/fullchain.pem" \
    --reloadcmd "systemctl reload nginx"

# 安装 Xray
echo -e "${GREEN}安装 Xray...${NC}"
bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# 写入 Xray 配置
echo -e "${GREEN}写入 Xray 配置...${NC}"
cat > /usr/local/etc/xray/config.json <<EOF
{
  "log": { "loglevel": "warning" },
  "inbounds": [
    {
      "port": $XRAY_PORT,
      "protocol": "vless",
      "settings": {
        "clients": [{ "id": "$UUID" }],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": { "path": "$WS_PATH" }
      }
    }
  ],
  "outbounds": [{ "protocol": "freedom" }]
}
EOF

systemctl restart xray
systemctl enable xray

# ================================
# 自动生成随机伪装站点（方案 C）
# ================================
echo -e "${GREEN}生成随机伪装站点...${NC}"

rm -rf /var/www/html
mkdir -p /var/www/html

TITLES=("My Blog" "Tech Notes" "Daily Journal" "Creative Studio" "Digital Portfolio")
SUBTITLES=("Thoughts and ideas" "Exploring creativity" "Learning and sharing" "A place to grow")
PARAGRAPHS=("More content coming soon." "Thanks for visiting." "Stay tuned for updates." "New posts will appear soon.")

TITLE=${TITLES[$RANDOM % ${#TITLES[@]}]}
SUB=${SUBTITLES[$RANDOM % ${#SUBTITLES[@]}]}
PARA=${PARAGRAPHS[$RANDOM % ${#PARAGRAPHS[@]}]}

cat > /var/www/html/index.html <<HTML
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>$TITLE</title>
<style>
body { font-family: Arial; background:#f5f5f5; padding:50px; }
.container { max-width:800px; margin:auto; background:white; padding:40px; border-radius:12px; }
</style>
</head>
<body>
<div class="container">
<h1>$TITLE</h1>
<h3>$SUB</h3>
<p>$PARA</p>
</div>
</body>
</html>
HTML

# Nginx 配置
echo -e "${GREEN}配置 Nginx...${NC}"
cat > /etc/nginx/conf.d/vless.conf <<EOF
server {
    listen 80;
    server_name $DOMAIN;
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    ssl_certificate $CERT_PATH/fullchain.pem;
    ssl_certificate_key $CERT_PATH/privkey.pem;

    root /var/www/html;
    index index.html;

    location $WS_PATH {
        proxy_pass http://127.0.0.1:$XRAY_PORT;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
    }
}
EOF

nginx -t && systemctl restart nginx

# 自动续期
cat > /etc/cron.daily/acme-renew <<EOF
#!/bin/bash
$ACME --cron --home /root/.acme.sh > /dev/null
systemctl reload nginx
EOF
chmod +x /etc/cron.daily/acme-renew

# ================================
# 输出节点信息 + 写入文本文件
# ================================
VLESS_LINK="vless://$UUID@$DOMAIN:443?encryption=none&security=tls&type=ws&host=$DOMAIN&path=$WS_PATH#$DOMAIN"

echo -e "${GREEN}=== 安装完成！===${NC}"
echo
echo -e "${GREEN}VLESS 节点信息：${NC}"
echo "$VLESS_LINK"
echo

echo "$VLESS_LINK" > /root/vless.txt
echo -e "${GREEN}节点信息已写入：/root/vless.txt${NC}"
echo
echo -e "${YELLOW}请将 Cloudflare DNS 切换为橙云（Proxied）${NC}"
